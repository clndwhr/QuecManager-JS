#!/bin/sh /etc/rc.common
START=50
STOP=10
USE_PROCD=1

start_service() {
    # Check if monitoring is enabled in UCI configuration
    MONITOR_ENABLED=$(uci get quecmanager.connection_monitor.enabled 2>/dev/null || echo "0")
    echo "Connection Monitor UCI config check. MONITOR_ENABLED='$MONITOR_ENABLED'"
    
    case "$MONITOR_ENABLED" in
        true|1|on|yes|enabled)
            # Verify required configuration files exist
            if [ ! -f "/etc/msmtprc" ] || [ ! -f "/etc/quecmanager_alert_recipient" ]; then
                echo "ERROR: Connection Monitor enabled but email configuration is missing"
                echo "Please configure email settings before enabling the monitor"
                return 1
            fi
            
            # Verify required packages are installed
            if ! opkg list-installed | grep -q "^msmtp "; then
                echo "ERROR: Connection Monitor enabled but msmtp package is not installed"
                return 1
            fi
            
            echo "Starting Connection Monitor Daemon..."
            procd_open_instance
            procd_set_param command /www/cgi-bin/services/connection_monitor_daemon.sh
            procd_set_param respawn
            procd_set_param stdout 1
            procd_set_param stderr 1
            procd_close_instance
            echo "Connection Monitor Daemon started"
            ;;
        *)
            echo "Connection Monitor Daemon disabled in configuration (value: '$MONITOR_ENABLED')"
            ;;
    esac
}

stop_service() {
    echo "Stopping Connection Monitor Daemon..."
    # procd will handle stopping the instance automatically
}

restart() {
    stop
    sleep 2
    start
}
