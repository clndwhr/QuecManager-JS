#!/bin/sh /etc/rc.common
# AT Queue System Init Script for OpenWRT

START=98  # Changed from 99 to run before quecprofiles
USE_PROCD=1
PROG="/www/cgi-bin/services/at_queue_manager"
METRICS_SCRIPT="/www/cgi-bin/services/log_signal_metrics.sh"

start_service() {
    # Create required directories
    mkdir -p /tmp/at_queue/results
    chmod 755 /tmp/at_queue
    chmod 755 /tmp/at_queue/results
    
    # Clean up any stale lock or token files
    [ -d "/tmp/at_queue/lock" ] && rmdir "/tmp/at_queue/lock" 2>/dev/null
    [ -f "/tmp/at_queue/token" ] && rm -f "/tmp/at_queue/token" 2>/dev/null
    [ -f "/tmp/at_queue/active" ] && rm -f "/tmp/at_queue/active" 2>/dev/null
    
    # Start AT queue manager
    procd_open_instance "at_queue_manager"
    procd_set_param command $PROG
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance
    
    # Start signal metrics logging service if available
    if [ -x "$METRICS_SCRIPT" ]; then
        logger -t at_queue -p daemon.info "Starting signal metrics logging"
        sh "$METRICS_SCRIPT" &
    fi
}

stop_service() {
    # Stop signal metrics logging if running
    if [ -f "/tmp/signal_metrics.pid" ]; then
        local metrics_pid=$(cat "/tmp/signal_metrics.pid")
        if kill -0 "$metrics_pid" 2>/dev/null; then
            kill "$metrics_pid" 2>/dev/null
            logger -t at_queue -p daemon.info "Stopped signal metrics logging"
        fi
        rm -f "/tmp/signal_metrics.pid"
    fi
    
    # Clean up token file to prevent locking
    [ -f "/tmp/at_queue/token" ] && rm -f "/tmp/at_queue/token" 2>/dev/null
}

service_triggers() {
    procd_add_reload_trigger "network"
}

reload_service() {
    stop
    start
}